name: Build and Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      custom_tag:
        description: 'Optional custom tag'
        required: false
        type: string

permissions:
  contents: write

defaults:
  run:
    shell: pwsh

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Validate Secrets
        run: |
          $missing = @()
          if (-not "${{ secrets.R2_ACCESS_KEY_ID }}") { $missing += "R2_ACCESS_KEY_ID" }
          if (-not "${{ secrets.R2_SECRET_ACCESS_KEY }}") { $missing += "R2_SECRET_ACCESS_KEY" }
          if (-not "${{ secrets.R2_ENDPOINT }}") { $missing += "R2_ENDPOINT" }
          if ($missing) { throw "Missing required secrets: $($missing -join ', ')" }

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Calculate Version
        id: version
        env:
          CUSTOM_TAG: ${{ github.event.inputs.custom_tag }}
        run: |
          $now = (Get-Date).ToUniversalTime()
          $revision = $now.Hour * 60 + $now.Minute
          $ver = "{0}.{1}.{2}.{3}" -f $now.Year, $now.Month, $now.Day, $revision

          Write-Host "Calculated Version: $ver"

          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          if ($env:CUSTOM_TAG) {
            "tag=$($env:CUSTOM_TAG.Trim())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            "tag=v$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }

      - name: Configure CMake
        run: >
          cmake -S . -B build
          -A x64
          -DCMAKE_BUILD_TYPE=Release
          -DDETARGET_VERSION="${{ steps.version.outputs.version }}"

      - name: Build
        run: cmake --build build --config Release

      - name: Package
        run: |
          Remove-Item dist -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path dist -Force | Out-Null

          $dllPath = "build/Release/Detarget.dll"
          $pdbPath = "build/Release/Detarget.pdb"
          if (-not (Test-Path $dllPath)) { throw "Build failed: $dllPath not found" }
          if (-not (Test-Path $pdbPath)) { throw "Build failed: $pdbPath not found" }

          Copy-Item $dllPath, $pdbPath -Destination dist

          Get-ChildItem dist -Filter *.dll | ForEach-Object {
            (Get-FileHash $_.FullName -Algorithm MD5).Hash.ToLower() | Set-Content "$($_.FullName).md5"
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: detarget-build
          path: dist/*

      - name: Upload to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_EC2_METADATA_DISABLED: true
        run: |
          $tag = "${{ steps.version.outputs.tag }}"
          $bucket = "s3://gw2-addons/detarget"
          $endpoint = "${{ secrets.R2_ENDPOINT }}"

          aws s3 sync dist "$bucket/$tag" --endpoint-url $endpoint --region us-east-1 --cache-control "public, max-age=31536000, immutable"
          aws s3 sync dist "$bucket/latest" --endpoint-url $endpoint --region us-east-1 --cache-control "public, max-age=300"

      - name: Release (Private)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Detarget ${{ steps.version.outputs.version }}
          body: Automated release for build ${{ steps.version.outputs.version }}
          files: dist/*

      - name: Release (Public)
        uses: softprops/action-gh-release@v2
        with:
          repository: jake-greygoose/DetargetKeybind-Releases
          tag_name: ${{ steps.version.outputs.tag }}
          name: Detarget ${{ steps.version.outputs.version }}
          body: Automated release for build ${{ steps.version.outputs.version }}
          files: dist/*
          token: ${{ secrets.RELEASE_REPO_TOKEN }}
