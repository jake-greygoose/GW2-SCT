name: Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  windows-build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          fetch-tags: true


      - name: Seed build version
        id: seed
        run: |
          $now = Get-Date
          $minuteOfDay = $now.Hour * 60 + $now.Minute
          $versionCore = $now.ToString('yyyy.M.d.') + $minuteOfDay
          $versionString = "v$versionCore"
          "GW2SCT_BUILD_NUMBER=$minuteOfDay" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "GW2SCT_VERSION_STRING=$versionString" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "seeded_version=$versionString" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Seeded GW2SCT version: $versionString"
        shell: pwsh

      - name: Configure (CMake)
        run: cmake -S . -B out/build-ci -G "Visual Studio 17 2022" -A x64
        shell: pwsh

      - name: Capture GW2-SCT version
        id: version
        run: |
          $cache = Get-Content out/build-ci/CMakeCache.txt
          $line = $cache | Where-Object { $_ -match '^GW2SCT_VERSION_STRING:STRING=(.+)$' } | Select-Object -First 1
          if (-not $line) {
            throw 'GW2SCT_VERSION_STRING not found in CMakeCache.txt'
          }
          $version = $Matches[1]
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Resolved version: $version"
        shell: pwsh

      - name: Build Release
        run: cmake --build out/build-ci --config Release --parallel
        shell: pwsh

      - name: Build Debug
        run: cmake --build out/build-ci --config Debug --parallel
        shell: pwsh

      - name: Package Release artifacts
        id: package
        run: |
          $dll = Join-Path 'out/build-ci/Release' 'gw2-sct.dll'
          if (-not (Test-Path $dll)) {
            throw "Release DLL not found at $dll"
          }
          $pdb = Join-Path 'out/build-ci/Release' 'gw2-sct.pdb'
          if (-not (Test-Path $pdb)) {
            throw "Release PDB not found at $pdb"
          }
          $version = '${{ steps.version.outputs.version }}'
          if (-not $version) {
            throw 'Missing GW2-SCT version output'
          }
          New-Item -ItemType Directory -Path release_package -Force | Out-Null
          $dllDest = Join-Path 'release_package' 'gw2-sct.dll'
          $pdbDest = Join-Path 'release_package' 'gw2-sct.pdb'
          Copy-Item $dll $dllDest -Force
          Copy-Item $pdb $pdbDest -Force
          $hash = Get-FileHash -Path $dllDest -Algorithm MD5
          $md5Dest = Join-Path 'release_package' 'gw2-sct.dll.md5'
          Set-Content -Path $md5Dest -Value ($hash.Hash.ToLowerInvariant()) -Encoding ascii
          $dllResolved = (Resolve-Path $dllDest).Path
          $pdbResolved = (Resolve-Path $pdbDest).Path
          $md5Resolved = (Resolve-Path $md5Dest).Path
          "package_dir=release_package" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "dll_path=$dllResolved" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "pdb_path=$pdbResolved" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "md5_path=$md5Resolved" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "dll_path_posix=release_package/gw2-sct.dll" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "pdb_path_posix=release_package/gw2-sct.pdb" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "md5_path_posix=release_package/gw2-sct.dll.md5" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Packaged release artifacts => release_package"
        shell: pwsh

      - name: Determine previous tag
        id: changelog
        run: |
          git fetch --tags --force | Out-Null
          $currentTag = '${{ steps.version.outputs.tag }}'
          if (-not $currentTag) {
            throw 'Missing current tag output'
          }
          $tags = git tag --sort=-creatordate
          $previous = $null
          foreach ($tag in $tags) {
            if ($tag -ne $currentTag) {
              $previous = $tag
              break
            }
          }
          if ($previous) {
            $githubCompare = "https://github.com/jake-greygoose/GW2-SCT/compare/$previous...$currentTag"
            $forgejoCompare = "https://git.gay/jake-greygoose/GW2-SCT/compare/$previous...$currentTag"
            $githubLine = "Full Changelog: [$previous...$currentTag]($githubCompare)"
            $forgejoLine = "Full Changelog: [$previous...$currentTag]($forgejoCompare)"
            "previous_tag=$previous" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "full_changelog_line_github=$githubLine" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "full_changelog_line_forgejo=$forgejoLine" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "Previous tag detected: $previous"
          } else {
            "previous_tag=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "full_changelog_line_github=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "full_changelog_line_forgejo=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "No previous tag found; skipping changelog compare line"
          }
        shell: pwsh

      - name: Upload Release DLL artifact
        uses: actions/upload-artifact@v4
        with:
          name: gw2-sct-${{ steps.version.outputs.version }}
          path: ${{ steps.package.outputs.package_dir }}


      - name: Create Forgejo release
        if: github.event_name != 'pull_request'
        env:
          FORGEJO_TOKEN: ${{ secrets.FORGEJO_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          PACKAGE_DLL: ${{ steps.package.outputs.dll_path }}
          PACKAGE_PDB: ${{ steps.package.outputs.pdb_path }}
          PACKAGE_MD5: ${{ steps.package.outputs.md5_path }}
          CHANGELOG_LINE: ${{ steps.changelog.outputs.full_changelog_line_forgejo }}
        shell: pwsh
        run: |
          if (-not $env:FORGEJO_TOKEN) {
            Write-Host "FORGEJO_TOKEN not set; skipping Forgejo release"
            exit 0
          }
          $repo = 'jake-greygoose/GW2-SCT'
          $base = 'https://git.gay/api/v1'
          $headers = @{ Authorization = "token $env:FORGEJO_TOKEN" }
          $body = "Automated mirror release from GitHub run $env:GITHUB_RUN_NUMBER."
          if ($env:CHANGELOG_LINE) {
            $body = "$body`n`n$env:CHANGELOG_LINE"
          }
          $json = @{ tag_name = $env:VERSION; name = $env:VERSION; body = $body } | ConvertTo-Json -Compress
          try {
            $release = Invoke-RestMethod -Method POST -Uri "$base/repos/$repo/releases" -Headers $headers -ContentType 'application/json' -Body $json -ErrorAction Stop
          } catch {
            if ($_.Exception.Response.StatusCode.Value__ -eq 409) {
              $release = Invoke-RestMethod -Method GET -Uri "$base/repos/$repo/releases/tags/$($env:VERSION)" -Headers $headers -ErrorAction Stop
            } else { throw }
          }
          if (-not $release.id) { throw 'Forgejo release id missing' }
          $packageFiles = @($env:PACKAGE_DLL, $env:PACKAGE_PDB, $env:PACKAGE_MD5) | Where-Object { $_ -and (Test-Path $_) }
          if (-not $packageFiles -or $packageFiles.Count -eq 0) {
            throw 'No release files found to upload to Forgejo'
          }
          foreach ($file in $packageFiles) {
            $fileName = Split-Path $file -Leaf
            $encodedName = [System.Web.HttpUtility]::UrlEncode($fileName)
            $uploadUri = "$base/repos/$repo/releases/$($release.id)/assets?name=$encodedName"
            Invoke-RestMethod -Method POST -Uri $uploadUri -Headers $headers -InFile $file -ContentType 'application/octet-stream' -ErrorAction Stop
            Write-Host "Uploaded $fileName to Forgejo release $($env:VERSION)"
          }
          Write-Host "Forgejo release published: $env:VERSION"

      - name: Create GitHub Release
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body: |
            Version: ${{ steps.version.outputs.version }}
            ${{ steps.changelog.outputs.full_changelog_line_github }}
          files: |
            ${{ steps.package.outputs.dll_path_posix }}
            ${{ steps.package.outputs.pdb_path_posix }}
            ${{ steps.package.outputs.md5_path_posix }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || github.token }}
